<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Bad Apple ASCII Player</title>
    <style>
        body { background: black; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; margin: 0; font-family: monospace; }
        #ascii-output { white-space: pre; line-height: 0.9; letter-spacing: 0; font-weight: bold; text-align: center; color: #fff; text-shadow: 0 0 5px #fff; }
        #controls { margin-top: 20px; padding: 15px; border: 1px solid #444; border-radius: 10px; text-align: center; }
        #status { color: #ffcc00; margin-bottom: 10px; font-size: 0.9rem; }
        button { padding: 10px 25px; cursor: pointer; background: #fff; color: #000; border: none; border-radius: 5px; font-weight: bold; }
        video { display: none; }
    </style>
</head>
<body>
    <div id="status">영상 파일을 선택해 주세요 (mp4 권장)</div>
    <div id="ascii-output">READY</div>

    <div id="controls">
        <input type="file" id="file-input" accept="video/*"><br><br>
        <button id="btn">PLAY / PAUSE</button>
    </div>

    <video id="video" loop preload="auto" crossorigin="anonymous"></video>
    <canvas id="canvas" style="display:none;"></canvas>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const output = document.getElementById('ascii-output');
        const status = document.getElementById('status');
        const btn = document.getElementById('btn');
        const fileInput = document.getElementById('file-input');

        // ASCII 문자셋 (자료 기반: 밀도별 배치)
        const asciiChars = " .:-=+*#%@";
        const charRatio = 0.55; // 문자 너비 비율 보정

        fileInput.onchange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const url = URL.createObjectURL(file);
                video.src = url;
                video.load(); // 강제 로드
                status.textContent = `파일 로드 중: ${file.name}`;
            }
        };

        // 비디오 소스 에러 체크
        video.onerror = () => {
            status.textContent = "❌ 에러: 지원하지 않는 영상 형식입니다.";
            console.error("Video Error Code:", video.error.code);
        };

        video.onloadedmetadata = () => {
            status.textContent = "✅ 로드 완료! PLAY를 누르세요.";
        };

        function render() {
            if (video.paused || video.ended) return;

            const w = 100; // 해상도 (성능과 가독성의 타협점)
            const h = Math.floor(w / (video.videoWidth / video.videoHeight) * charRatio);
            
            if (h <= 0 || isNaN(h)) {
                requestAnimationFrame(render);
                return;
            }

            canvas.width = w;
            canvas.height = h;
            ctx.drawImage(video, 0, 0, w, h);

            const data = ctx.getImageData(0, 0, w, h).data;
            let art = "";

            for (let y = 0; y < h; y++) {
                for (let x = 0; x < w; x++) {
                    const i = (y * w + x) * 4;
                    // 명도 계산 (자료 알고리즘: 평균값)
                    const gray = (data[i] + data[i+1] + data[i+2]) / 3; 
                    const charIdx = Math.floor((gray / 255) * (asciiChars.length - 1));
                    art += asciiChars[charIdx];
                }
                art += "\n";
            }

            output.textContent = art;
            // 화면 크기에 따른 폰트 최적화
            const fontSize = Math.min(window.innerWidth / w * 1.6, window.innerHeight / h * 1.1);
            output.style.fontSize = fontSize + "px";

            requestAnimationFrame(render);
        }

        btn.onclick = async () => {
            if (!video.src) {
                status.textContent = "⚠️ 파일을 먼저 선택해 주세요!";
                return;
            }
            try {
                if (video.paused) {
                    await video.play();
                    render();
                } else {
                    video.pause();
                }
            } catch (err) {
                status.textContent = "❌ 재생 실패: 브라우저가 파일을 거부했습니다.";
                console.error(err);
            }
        };
    </script>
</body>
</html>
